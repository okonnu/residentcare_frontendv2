<div class="table-form-container">
  <!-- View Mode (Table Display) -->
  @if (isViewMode) {
  <mat-card class="cardWithShadow">
    <mat-card-content>
      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <mat-card-title>{{ title }}</mat-card-title>
          @if (subtitle) {
          <mat-card-subtitle>{{ subtitle }}</mat-card-subtitle>
          }
        </div>

        @if (showAddButton) {
        <button mat-raised-button color="primary" (click)="addNew()">
          <mat-icon>add</mat-icon> Add Record
        </button>
        }
      </div>

      <!-- Table view -->
      <div class="table-responsive">
        <table mat-table [dataSource]="dataSource" matSort class="w-100">

          <!-- Dynamic columns based on formControls -->
          @for (column of columns; track column.key) {
          <ng-container [matColumnDef]="column.key">

            <!-- Header cell -->
            <th mat-header-cell *matHeaderCellDef [style.width]="column.width || 'auto'" [style.min-width]="'120px'"
              [mat-sort-header]="column.sortable ? column.key : ''" [disabled]="!column.sortable">
              {{ column.title }}
            </th>

            <!-- Data cell (Display only) -->
            <td mat-cell *matCellDef="let row" [style.min-width]="'120px'">
              @if (column.displayFn) {
              {{ column.displayFn(row) }}
              } @else {
              {{ getPropertyValue(row, column.key) }}
              }
            </td>
          </ng-container>
          }

          <!-- Actions Column -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef style="min-width: 150px;"> Actions </th>
            <td mat-cell *matCellDef="let row" style="min-width: 150px;">
              <div class="actions-container">
                @if (showViewButton) {
                <button mat-icon-button color="primary" (click)="viewRecord(row)" matTooltip="View">
                  <mat-icon>visibility</mat-icon>
                </button>
                }

                @if (showEditButton) {
                <button mat-icon-button color="accent" (click)="editRecord(row)" matTooltip="Edit">
                  <mat-icon>edit</mat-icon>
                </button>
                }

                @if (showDeleteButton) {
                <button mat-icon-button color="warn" (click)="deleteRecord(row)" matTooltip="Delete">
                  <mat-icon>delete</mat-icon>
                </button>
                }
              </div>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>

        <!-- No data message -->
        @if (dataSource.data.length === 0) {
        <div class="no-data-message">
          <p>No records available</p>
        </div>
        }

        <!-- Pagination -->
        <mat-paginator [pageSizeOptions]="[5, 10, 25, 100]" showFirstLastButtons></mat-paginator>
      </div>

    </mat-card-content>
  </mat-card>
  }
  <!-- Form Mode (View/Edit/Add using Card Form) -->
  @if (isFormMode && selectedRecord) {
  <!-- Header with back button -->
  <div class="d-flex justify-content-between align-items-center mb-4">
      <button mat-icon-button (click)="switchToViewMode()" matTooltip="Back to table">
      <mat-icon>arrow_back</mat-icon>
    </button>
  </div>

  <!-- Card Form Component -->
  <card-form [formControls]="selectedRecord" [title]="cardTitle" [editMode]="isEditMode || isAddMode"
    [showEditButton]="isDetailMode" [showCancelButton]="true" [editButtonText]="'Edit'"
    [saveButtonText]="isAddMode ? 'Add Record' : 'Save Changes'" [cancelButtonText]="'Cancel'" (save)="onSave($event)"
    (cancel)="onCancel()" (edit)="onEdit()">
  </card-form>
  }
</div>