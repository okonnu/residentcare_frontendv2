<div class="table-form-container">
  <mat-card class="cardWithShadow">
    <mat-card-content>
      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <mat-card-title>{{ title }}</mat-card-title>
          @if (subtitle) {
            <mat-card-subtitle>{{ subtitle }}</mat-card-subtitle>
          }
        </div>
        
        @if (showAddButton) {
          <button mat-raised-button color="primary" (click)="addNew()">
            <mat-icon>add</mat-icon> Add Record
          </button>
        }
      </div>
      
      <!-- Table view -->
      <div class="table-responsive">
        <table mat-table [dataSource]="dataSource" matSort class="w-100">
          
          <!-- Dynamic columns based on input configuration -->
          @for (column of columns; track column.key) {
            <ng-container [matColumnDef]="column.key" 
                          >
              
              <!-- Header cell -->
            <th mat-header-cell *matHeaderCellDef 
                [style.width]="column.width || 'auto'"
                [mat-sort-header]="column.sortable ? column.key : ''"
                [disabled]="!column.sortable">
              {{ column.title }}
            </th>
            
            <!-- Data cell -->
            <td mat-cell *matCellDef="let row">
              <!-- Display mode -->
              @if (!isEditing(row)) {
                @if (column.displayFn) {
                  {{ column.displayFn(row) }}
                } @else {
                  {{ getPropertyValue(row, column.key) }}
                }
              }
              
              <!-- Edit mode -->
              @if (isEditing(row)) {
                <!-- Text, Number, Date, Email inputs -->
                @if (['text', 'number', 'date', 'email', 'tel'].includes(column.dataType)) {
                  <mat-form-field appearance="outline" class="w-100 compact-form-field">
                    <input type="{{column.dataType}}" matInput [(ngModel)]="row[column.key]" 
                           [name]="column.key" />
                  </mat-form-field>
                }
                
                <!-- Dropdown (Select) -->
                @if (column.dataType === 'select') {
                  <mat-form-field appearance="outline" class="w-100 compact-form-field">
                    <mat-select [(ngModel)]="row[column.key]" [name]="column.key">
                      @for (option of column.options; track option.value) {
                        <mat-option [value]="option.value">
                          {{option.label}}
                        </mat-option>
                      }
                  </mat-select>
                </mat-form-field>
                }
                
                <!-- Radio Buttons -->
                @if (column.dataType === 'radio') {
                  <div class="radio-group">
                    <mat-radio-group [(ngModel)]="row[column.key]" [name]="column.key">
                      @for (option of column.options; track option.value) {
                        <mat-radio-button [value]="option.value" class="radio-button">
                          {{option.label}}
                        </mat-radio-button>
                      }
                    </mat-radio-group>
                  </div>
                }
                
                <!-- SSN input with mask -->
                @if (column.dataType === 'ssn') {
                  <mat-form-field appearance="outline" class="w-100 compact-form-field">
                    <input 
                      type="text" 
                      matInput 
                      [(ngModel)]="row[column.key]" 
                      [name]="column.key" 
                      mask="000-00-0000"
                      [showMaskTyped]="true"
                      placeholder="___-__-____"
                    />
                  </mat-form-field>
                }

                <!-- Custom input (e.g., for blood pressure) -->
                @if (column.dataType === 'custom') {
                  <!-- Custom handling based on column key -->
                  @if (column.key === 'bloodPressure') {
                    <div class="d-flex gap-2">
                      <mat-form-field appearance="outline" class="compact-form-field">
                        <input type="number" matInput [(ngModel)]="row['systolicBP']" 
                               name="systolicBP" placeholder="Systolic" />
                      </mat-form-field>
                      <span class="align-self-center">/</span>
                      <mat-form-field appearance="outline" class="compact-form-field">
                        <input type="number" matInput [(ngModel)]="row['diastolicBP']" 
                               name="diastolicBP" placeholder="Diastolic" />
                      </mat-form-field>
                    </div>
                  }
                }
              }
            </td>
          </ng-container>
          }
          
          <!-- Actions Column -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef> Actions </th>
            <td mat-cell *matCellDef="let row">
              <!-- Display mode actions -->
              @if (!isEditing(row)) {
                <div class="actions-container">
                  @if (showViewButton) {
                    <button mat-icon-button color="primary" 
                            (click)="viewRecord(row)" matTooltip="View">
                      <mat-icon>visibility</mat-icon>
                    </button>
                  }
                  
                  @if (showEditButton && allowInlineEdit) {
                    <button mat-icon-button color="accent" 
                            (click)="startEdit(row)" matTooltip="Edit">
                      <mat-icon>edit</mat-icon>
                    </button>
                  }
                  
                  @if (showEditButton && !allowInlineEdit) {
                    <button mat-icon-button color="accent" 
                            (click)="editRecord(row)" matTooltip="Edit">
                      <mat-icon>edit</mat-icon>
                    </button>
                  }
                  
                  @if (showDeleteButton) {
                    <button mat-icon-button color="warn" 
                            (click)="deleteRecord(row)" matTooltip="Delete">
                      <mat-icon>delete</mat-icon>
                    </button>
                  }
                </div>
              }
              
              <!-- Edit mode actions -->
              @if (isEditing(row)) {
                <div class="actions-container">
                  <button mat-icon-button color="primary" 
                          (click)="saveEdit()" matTooltip="Save">
                    <mat-icon>save</mat-icon>
                  </button>
                  
                  <button mat-icon-button color="warn" 
                          (click)="cancelEdit()" matTooltip="Cancel">
                    <mat-icon>cancel</mat-icon>
                  </button>
                </div>
              }
            </td>
          </ng-container>
          
          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"
              [ngClass]="{'editing-row': isEditing(row)}"></tr>
        </table>
        
        <!-- No data message -->
        @if (dataSource.data.length === 0) {
          <div class="no-data-message">
            <p>No records available</p>
          </div>
        }
        
        <!-- Debug info -->
        <div class="mt-3 mb-3 p-2 border border-secondary">
          <h5>Debug Info</h5>
          <p>Data length: {{ dataSource.data.length }}</p>
          <p>Displayed columns: {{ displayedColumns.join(', ') }}</p>
        </div>
        
        <!-- Pagination -->
        <mat-paginator [pageSizeOptions]="[5, 10, 25, 100]" showFirstLastButtons></mat-paginator>
      </div>
    </mat-card-content>
  </mat-card>
</div>
